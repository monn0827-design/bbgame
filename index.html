<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Brick Breaker - Firebase 연동</title>
    <style>
        :root {
            --primary-color: #4a90e2;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-color: #333;
        }

        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: var(--bg-color);
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            overflow: hidden;
            touch-action: none;
        }

        #game-container {
            position: relative;
            background: var(--card-bg);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 95vw;
        }

        canvas {
            background: #1a1a1a;
            border-radius: 10px;
            display: block;
            margin: 0 auto;
            max-width: 100%;
            height: auto;
            cursor: none;
        }

        .stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-weight: bold;
            color: var(--text-color);
            font-size: 1.2rem;
        }

        /* UI Modals */
        .modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.98);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
            z-index: 100;
            width: 80%;
            max-width: 350px;
        }

        #ranking-container {
            margin-top: 15px;
            text-align: left;
            border-top: 1px solid #eee;
            padding-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            margin: 5px 0;
            color: #555;
        }

        .ranking-item.current-user {
            color: var(--primary-color);
            font-weight: bold;
        }

        button {
            padding: 12px 20px;
            font-size: 1rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            font-weight: bold;
        }

        .instructions {
            margin-top: 15px;
            color: #666;
            font-size: 0.8rem;
        }

        #connection-status {
            font-size: 0.7rem;
            color: #aaa;
            margin-top: 5px;
        }
    </style>
</head>
<body>

<div id="game-container">
    <div class="stats">
        <span>Score: <span id="score">0</span></span>
        <span>Level: <span id="level">1</span></span>
    </div>
    
    <canvas id="gameCanvas"></canvas>
    
    <!-- Game Over UI -->
    <div id="ui-layer" class="modal">
        <h2 id="ui-title">Game Over</h2>
        <p id="ui-message">Final Score: 0</p>
        
        <div id="ranking-container">
            <h4 style="margin: 0 0 10px 0;">Top 5 Ranking</h4>
            <div id="ranking-list">점수 로드 중...</div>
        </div>

        <button onclick="resetGame()">다시 시작</button>
    </div>

    <div id="connection-status">Firebase 연결 대기 중...</div>

    <div class="instructions">
        마우스, 키보드, 터치로 이동 / 실시간 랭킹 시스템
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

    // 제공된 Firebase 설정 반영
    const firebaseConfig = {
        apiKey: "AIzaSyB0W1tWB78MOiq23hgdyUylnmAUyAU2F-w",
        authDomain: "bbgamen-b40de.firebaseapp.com",
        databaseURL: "https://bbgamen-b40de-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "bbgamen-b40de",
        storageBucket: "bbgamen-b40de.firebasestorage.app",
        messagingSenderId: "589403701818",
        appId: "1:589403701818:web:65a4dc3d8982fc2989ab03",
        measurementId: "G-FMGN23W9GX"
    };

    // Firebase 초기화
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const statusEl = document.getElementById('connection-status');

    let currentUser = null;
    let unsubscribeRanking = null;

    // 인증 처리
    async function startAuth() {
        try {
            await signInAnonymously(auth);
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    statusEl.innerText = `Connected: ${user.uid.substring(0, 8)}`;
                    loadRanking();
                }
            });
        } catch (error) {
            console.error("Auth error:", error);
            statusEl.innerText = "Firebase 연결 실패";
            statusEl.style.color = "red";
        }
    }

    // 랭킹 저장
    async function saveScore(finalScore) {
        if (!currentUser) return;
        try {
            const scoreRef = doc(db, 'rankings', currentUser.uid);
            await setDoc(scoreRef, {
                userId: currentUser.uid,
                score: finalScore,
                updatedAt: Date.now()
            }, { merge: true });
        } catch (e) {
            console.error("Save error:", e);
        }
    }

    // 랭킹 로드
    function loadRanking() {
        const rankingQuery = collection(db, 'rankings');
        unsubscribeRanking = onSnapshot(rankingQuery, (snapshot) => {
            const scores = [];
            snapshot.forEach(doc => scores.push(doc.data()));
            scores.sort((a, b) => b.score - a.score);
            
            const top5 = scores.slice(0, 5);
            document.getElementById('ranking-list').innerHTML = top5.map((s, index) => `
                <div class="ranking-item ${s.userId === currentUser?.uid ? 'current-user' : ''}">
                    <span>${index + 1}. ${s.userId.substring(0, 6)}</span>
                    <span>${s.score} pts</span>
                </div>
            `).join('') || "순위 데이터가 없습니다.";
        });
    }

    // --- Game Logic ---
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const scoreElement = document.getElementById("score");
    const levelElement = document.getElementById("level");
    const uiLayer = document.getElementById("ui-layer");

    canvas.width = 480;
    canvas.height = 320;

    let ballRadius = 8;
    let x, y, dx, dy;
    let paddleHeight = 10;
    let paddleWidth = 75;
    let paddleX;
    let rightPressed = false;
    let leftPressed = false;
    let score = 0;
    let level = 1;
    let bricks = [];
    let isGameOver = false;

    function initBricks() {
        bricks = [];
        const cols = 5;
        const rows = 3;
        for (let c = 0; c < cols; c++) {
            bricks[c] = [];
            for (let r = 0; r < rows; r++) {
                bricks[c][r] = { x: 0, y: 0, status: 1 };
            }
        }
    }

    function resetBall() {
        x = canvas.width / 2;
        y = canvas.height - 30;
        dx = 2 + level;
        dy = -(2 + level);
        paddleX = (canvas.width - paddleWidth) / 2;
    }

    function draw() {
        if (isGameOver) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Bricks
        for (let c = 0; c < 5; c++) {
            for (let r = 0; r < 3; r++) {
                if (bricks[c][r].status === 1) {
                    let bx = (c * 85) + 30;
                    let by = (r * 30) + 30;
                    bricks[c][r].x = bx;
                    bricks[c][r].y = by;
                    ctx.beginPath();
                    ctx.roundRect(bx, by, 75, 20, 4);
                    ctx.fillStyle = `hsl(${c * 40 + 200}, 70%, 60%)`;
                    ctx.fill();
                    ctx.closePath();

                    if (x > bx && x < bx + 75 && y > by && y < by + 20) {
                        dy = -dy;
                        bricks[c][r].status = 0;
                        score += 10;
                        scoreElement.innerText = score;
                        let remaining = 0;
                        bricks.forEach(col => col.forEach(b => { if(b.status === 1) remaining++ }));
                        if (remaining === 0) {
                            level++;
                            levelElement.innerText = level;
                            resetBall();
                            initBricks();
                        }
                    }
                }
            }
        }

        // Ball
        ctx.beginPath();
        ctx.arc(x, y, ballRadius, 0, Math.PI * 2);
        ctx.fillStyle = "white";
        ctx.fill();
        ctx.closePath();

        // Paddle
        ctx.beginPath();
        ctx.roundRect(paddleX, canvas.height - paddleHeight - 5, paddleWidth, paddleHeight, 5);
        ctx.fillStyle = "#4a90e2";
        ctx.fill();
        ctx.closePath();

        if (x + dx > canvas.width - ballRadius || x + dx < ballRadius) dx = -dx;
        if (y + dy < ballRadius) dy = -dy;
        else if (y + dy > canvas.height - ballRadius - 5) {
            if (x > paddleX && x < paddleX + paddleWidth) {
                dy = -dy;
            } else {
                isGameOver = true;
                uiLayer.style.display = "block";
                document.getElementById('ui-message').innerText = `최종 점수: ${score}`;
                saveScore(score);
            }
        }

        if (rightPressed && paddleX < canvas.width - paddleWidth) paddleX += 7;
        else if (leftPressed && paddleX > 0) paddleX -= 7;

        x += dx;
        y += dy;
        requestAnimationFrame(draw);
    }

    // Input Events
    document.addEventListener("keydown", (e) => {
        if (e.key === "Right" || e.key === "ArrowRight") rightPressed = true;
        else if (e.key === "Left" || e.key === "ArrowLeft") leftPressed = true;
    });
    document.addEventListener("keyup", (e) => {
        if (e.key === "Right" || e.key === "ArrowRight") rightPressed = false;
        else if (e.key === "Left" || e.key === "ArrowLeft") leftPressed = false;
    });
    canvas.addEventListener("mousemove", (e) => {
        let rect = canvas.getBoundingClientRect();
        let rx = e.clientX - rect.left;
        if (rx > 0 && rx < canvas.width) paddleX = rx - paddleWidth / 2;
    });

    window.resetGame = () => {
        score = 0; level = 1; isGameOver = false;
        scoreElement.innerText = score; levelElement.innerText = level;
        uiLayer.style.display = "none";
        initBricks(); resetBall(); draw();
    };

    // 실행
    startAuth();
    initBricks();
    resetBall();
    draw();

</script>
</body>
</html>
